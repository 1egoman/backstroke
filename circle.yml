machine:
  node:
    version: 6
  environment:
    - NODE_ENV=test
    - GITHUB_TOKEN=phony

test:
  pre:
    - time npm run coverage

deployment:
  hub:
    branch: fix-it-all
    commands:
      # After tests ran successfully, build docker container.
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker build -t rgausnet/backstroke --build-arg ref=$TRAVIS_COMMIT .
      - docker push rgausnet/backstroke
  post:
    branch: fix-it-all
    commands:
      # install doctl to provision a droplet
      - wget https://github.com/digitalocean/doctl/releases/download/v1.6.0/doctl-1.6.0-linux-amd64.tar.gz
      - tar xf doctl*.tar.gz
      - mv doctl /usr/local/bin

      # Provision a new node on digitalocean
      - ./provision.sh "one"
