machine:
  environment:
    HOST: "root@67.205.187.179"

  node:
    version: 6

dependencies:
  override:
    - yarn:
        timeout: 180 # timeout after 3 minutes
        # IMPORTANT NOTE: ^^ the timeout modifier above must be
        # double indented (four spaces) from the previous line

test:
  override:
    - /bin/true

deployment:
  production:
    branch: fix-it-all
    commands:
      - scp -R backstroke/ $HOST:/app

      # Set up nginx
      - |
        ssh $HOST <<END
        sudo apt-get update
        sudo apt-get install -y nginx

        # For api.backstroke.us
        cat <<EOF > /etc/nginx/sites-enabled/api
        server {
          server_name api.backstroke.us;
          listen 80;

          location / {
            proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto \\\$http_x_forwarded_proto;
            proxy_set_header Host \\\$http_host;
            proxy_set_header X-Real-IP \\\$remote_addr;
            proxy_redirect off;
            proxy_pass http://localhost:8000;
          }
        }
        EOF

        systemctl restart nginx
      END

      # Set up nvm, node, and deployment utilities, then boot server
      - |
        sudo apt-get install -y build-essential libssl-dev curl git
        curl -sL https://raw.githubusercontent.com/creationix/nvm/v0.31.0/install.sh | bash
        . "\$HOME/.nvm/nvm.sh"

        # Install node, yarn, and pm2
        nvm install v6
        echo "node -v = \$(node -v)"
        echo "npm -v = \$(npm -v)"
        [ -f \$(which yarn) ] || npm i -g yarn
        [ -f \$(which pm2) ] || npm i -g pm2

        source /backstroke.env

        # Boot server
        cd /app/server
        [ -f \$(which babel) ] || npm i -g babel-cli
        yarn

        babel src/ -d dist/
        pm2 delete server
        pm2 start dist/server.js --name server
